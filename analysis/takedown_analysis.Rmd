---
title: "government_takedown_analysis"
output: html_document
date: "2024-09-13"
---

```{r}
# # First, you need to have the devtools package installed
# install.packages("devtools")
# # now, install the vdemdata package directly from GitHub
# devtools::install_github("vdeminstitute/vdemdata")
# library(vdemdata)

```


```{r}

library(tidyverse)

library(ggplot2)
library(reshape2)
library(vdemdata)
library(countrycode)
library(GGally)
library(broom)

library(MASS)

```

```{r}
file_list <- list.files(path = "~/joe_sturla_r/2024_takedown_analysis/data/", pattern ="PRPL-Facebook-Government-Report-20?", full.names = TRUE) 
data_list <- list()

file_list
```




```{r}
#clean dfs so they can be combined into one file
data_list <- list()
for (file in file_list) {
  # Read the current CSV file into a dataframe
  #print(file)
  df <- read.csv(file)
  
  # Extract the file name from the file path
  file_name <- basename(file)
  
  # Extract the year and half information from the file name
  # Assuming the format is like "PRPL-Facebook-Government-Report-YYYY_HX"
  # Where YYYY is the year and HX is the half of the year (H1 or H2)
  year_half <- gsub(".*-(\\d{4})_(H[12]).csv$", "\\1_\\2", file_name)
  
  # Split the extracted information into year and half
  year <- sub("_(H[12])$", "", year_half)
  half <- sub("^\\d{4}_(H[12])$", "\\1", year_half)
  
  # Determine the date based on the half of the year
  if (half == "H1") {
    date <- paste0("6/30/", year)
  } else if (half == "H2") {
    date <- paste0("12/31/", year)
  } else {
    date <- NA  # Handle unexpected cases
  }
  
  # df$Total.Requests.Percentage <- df$Total.Requests.Percentage|> 
  # str_replace_all("%|,", "")
  # 
  # 
  # df$Total.Requests <- sub(" -.*", "", df$Total.Requests)
  # df$Total.Requests <- df$Total.Requests |>
  #   str_replace_all("%|,", "")
  # 
  # df$Total.Requests.Accounts <- sub(" -.*", "", df$Total.Requests.Accounts)
  # df$Total.Requests.Accounts <- df$Total.Requests.Accounts |>
  #   str_replace_all("%|,", "")
  #   #unique(df$Total.Requests.Accounts)
  # 
  
  for (col in names(df)) {
    #print(col)
    if (col != "Country") {
      # Try to convert columns to numeric if they are not character columns
      # This will also handle integer and double columns consistently
      df[[col]] <- sub(" -.*", "", df[[col]])
      df[[col]] <- df[[col]] |>
        str_replace_all("%|,", "")
      
      df[[col]] <- as.numeric(df[[col]])
    }
  }
  
  # Add a new column with the date information
  df$Date <- date
  
  # Append the dataframe to the list
  data_list[[length(data_list) + 1]] <- df
}

```


```{r}

initial_df <- bind_rows(data_list)
combined_df <- initial_df
head(combined_df)
head(data_list[[3]])
sum(is.na(initial_df$Total.Requests.Percentage))

names(initial_df)
```

```{r}

#Remove columns with no data


combined_df <- combined_df |> dplyr::select(where(~ any(!is.na(.))))
combined_df |> filter(!is.na(Total.Requests.Percentage)) -> combined_df
combined_df$Platform <- "Facebook"
#add platform column, 
combined_df$Platform <- "Facebook"
head(combined_df)

#combined_df <- subset(combined_df, select = -platform)
#head(combined_df)
#reorder columns
combined_df <- combined_df %>% dplyr::select(Platform, Date, everything())

```
#is there anything based on the local office

# number of takedowns and number of approved takedowns
```{r}

names(combined_df)

```



```{r}
combined_df$Content.Restrictions <- coalesce(combined_df$Content.Restrictions, combined_df$Content.Restricted)


combined_df <- combined_df |> dplyr::select(-Content.Restricted)
```


```{r}
combined_df <- combined_df %>% dplyr::select(Platform, Date,Country, Content.Restrictions, everything())
names(combined_df)

#does content restrictions change by country
#does total request change by country


#series of chi square tests, one for each time period?

```
```{r}
# 
# ggplot(combined_df, aes(x = factor(Country), y = Content.Restrictions, fill = factor(Date))) +
#   geom_boxplot() +
#   labs(x = "Country", y = "Integer Variable", fill = "Year") +
#   theme_minimal()
```



```{r}
# 
# df_melt <- melt(combined_df, id.vars = c("Country", "Date"), value.name="Content.Restrictions")
# help(melt)
# df_melt
# ggplot(combined_df, aes(x = factor(Date), y = factor(Country), fill = Content.Restrictions)) +
#   geom_tile() +
#   scale_fill_gradient(low = "white", high = "blue") +
#   labs(x = "Date", y = "Country", fill = "Content.Restrictions") +
#   theme_minimal() +
#   theme(axis.text.y = element_text(size = 5))  # Adjust country labels for readability
```

```{r}
#install.packages("vdemdata")

#install.packages("devtools")
#devtools::install_github("vdeminstitute/vdemdata")



data("vdem")

#head(vdem)
#names(vdem)
#v2x_libdem

 
```
#fix dates, ensure that they line up
```{r}

#install.packages("countrycode")


# Ensure `date` column is of Date type (if not already)
combined_df$Date <- as.Date(combined_df$Date, format="%m/%d/%Y")
# Extract year from the `date` column in combined_df
combined_df <- combined_df %>%
  mutate(year = format(Date, "%Y"))  # Add a `year` column
# Convert `year` in both dataframes to numeric to avoid mismatches
combined_df$year <- as.numeric(combined_df$year)
vdem$year <- as.numeric(vdem$year)
```

```{r}

# Merge the dataframes using `left_join` based on country and year
#combined_df <- combined_df %>%
#names(vdem)
#names(combined_df)

vdem |> filter(str_detect(country_name, regex("^Cz")))


#vdem |> mutate(country_name = str_replace("Czechia", ""))
#unique(trouble_names_df$Country)

#trouble_names_df

# 
#only countries with libdem are somaliland (SML) and Kosovo (XKX)
# vdem |> filter(country_name %in% trouble_names_df$Country) |>
#   select(c(country_name, country_text_id, v2x_libdem)) |>
#   unique()



combined_df$country_code <- countrycode(combined_df$Country, "country.name", "iso3c")
# combined_df 
# names(vdem)
# vdem |> select(c(country_name, v2x_libdem)) |>
#   filter(str_detect(country_name, regex("^B")))




#fix kosovo, somaliland, save dropped countries
combined_df |> 
  mutate(country_code = case_when(
    Country == "Kosovo" ~ "XKX",
    Country == "Somaliland" ~ "SML",
    TRUE ~ country_code
  )) |> left_join(vdem |> dplyr::select(country_name, country_text_id, year, v2x_libdem), 
            by = c("country_code" = "country_text_id", "year" = "year")) |>
  dplyr::select(Country, country_name, country_code, year, everything()) -> combined_df

#combined_df
combined_df |> filter(is.na(v2x_libdem)) -> trouble_names_df

unique(trouble_names_df$Country) -> dropped_countries



#edit the working df to not include countries without a v2x_libdem score 

combined_df |> filter(!is.na(v2x_libdem)) -> combined_df


```



```{r}
#Load population, %population data
pop_df <- read_csv("../data/API_IT.NET.USER.ZS_DS2_en_csv_v2_3409961.csv", col_names = TRUE, skip=4)
#head(pop_df)
#help(read_csv)

pop_df <- pop_df |> dplyr::select(c(`Country Name`, `Country Code`) | starts_with('201') | starts_with('202')) |>
  dplyr::select(!c("2010", "2011", "2012"))
#names(pop_df)
#help(select)
```


```{r}
#pivot longer to group cols 
pop_df_fixed <- pop_df |> pivot_longer(cols = starts_with('20'), names_to = "year", values_to = "percent_pop_on_internet")
#names(pop_df_fixed)

#help(pivot_longer)
unique(pop_df_fixed$`Country Code`)
pop_df_fixed |> filter(str_detect(`Country Name`, regex("^S")))
```

```{r}
pop_df_fixed$year <- as.numeric(pop_df_fixed$year)
head(pop_df_fixed)
# 
# pop_df_fixed|> filter(`Country Name` %in% trouble_countries_df$country_name) |>
#   filter(!is.na(percent_pop_on_internet))
# 



```

```{r}
# Not sure if any of this needs to be ran, see next code chunk for solution
# combined_df |> left_join(pop_df_fixed, by = c("country_code" = "Country Code", "year" = "year")) -> joined_combined_df
# 
# 
# joined_combined_df$country_code <- as.factor(joined_combined_df$country_code)
# 
# joined_combined_df|>
#   group_by(country_code)|>
#   mutate(percent_pop_on_internet = ifelse(is.na(percent_pop_on_internet), mean(percent_pop_on_internet[!is.na(percent_pop_on_internet)], na.rm = TRUE), percent_pop_on_internet)) |>
#   ungroup() |>
#   select(c(Country,country_code, year, percent_pop_on_internet)) |>
#   filter(country_code == "XKX")
# 
# help(group_by)
# 
# 
# combined_df |> left_join(pop_df_fixed, by = c("country_code" = "Country Code", "year" = "year"))  |> filter(is.na(percent_pop_on_internet))|>
#   select(c(Country, country_code, year, percent_pop_on_internet))
# 
# combined_df |> left_join(pop_df_fixed, by = c("country_code" = "Country Code", "year" = "year"))  |> group_by(country_code)
# 
# head(combined_df)
```


#set NAs to country median, 
```{r}


combined_df |> left_join(pop_df_fixed, by = c("country_code" = "Country Code", "year" = "year")) -> joined_combined_df


joined_combined_df$country_code <- as.factor(joined_combined_df$country_code)




joined_combined_df |>
  dplyr::group_by(country_code) %>%
  dplyr::mutate(percent_pop_on_internet = ifelse(
    is.na(percent_pop_on_internet), 
    median(percent_pop_on_internet[!is.na(percent_pop_on_internet)], na.rm = TRUE), 
    percent_pop_on_internet)) %>%
  ungroup() |>
  filter(!is.na(percent_pop_on_internet)) -> combined_df

```



```{r}
#checking NAs, 0 is good
combined_df |> filter(is.na(percent_pop_on_internet))
sum(is.na(combined_df$percent_pop_on_internet))
```


#Load population data
```{r}

#Pineapple

flat_pop_df <- read_csv("../data/API_SP.POP.TOTL_DS2_en_csv_v2_3401680.csv", col_names = TRUE, skip=4)
head(flat_pop_df)


flat_pop_df <- flat_pop_df |> 
  dplyr::select(c(`Country Code`) | starts_with('201') | starts_with('202')) |>
  dplyr::select(!c("2010", "2011", "2012"))
names(flat_pop_df)


```



```{r}
#pivot longer to group cols 
flat_pop_df_fixed <- flat_pop_df |> pivot_longer(cols = starts_with('20'), names_to = "year", values_to = "population")
names(flat_pop_df_fixed)

#help(pivot_longer)
```

```{r}
flat_pop_df_fixed$year <- as.numeric(flat_pop_df_fixed$year)

head(combined_df)
#combined_df |> select(-c(`Country Code`, population)) -> combined_df
```

```{r}
combined_df |> left_join(flat_pop_df_fixed, by = c("country_code" = "Country Code", "year" = "year")) -> combined_df

combined_df
#joined_combined_df |> select(c(Country,country_code, population, year) )

#joined_combined_df$country_code <- as.factor(joined_combined_df$country_code)


```



#rewriting to add in country offices

```{r}
office_df <- read_csv("../data/Local-Offices-1.csv", col_names = TRUE)
head(office_df)

help(rename)
office_df <- office_df |> 
  dplyr::mutate("has_facebook_office" = `Facebook Office (1-0)`,
         "has_twitter_office" = `Twitter Office (1-0)`,
         "has_google_office" = `Google Office (1-0)` ) |>
  dplyr::select(-c(`Facebook Office (1-0)`,`Twitter Office (1-0)`,`Google Office (1-0)`))
head(office_df)


office_df$country_code <- countrycode(office_df$Country, "country.name", "iso3c")
office_df |>
  mutate(country_code = case_when(
    str_detect(Country, regex("^Cote")) ~ "CIV",
    Country == "Kosovo" ~ "XKX",
    TRUE ~ country_code)) |> filter(!is.na(country_code)) ->
  office_df

```

```{r}

office_df


combined_df <- combined_df |>
  left_join(office_df, by = c("country_code" = "country_code"))

combined_df |> names()

combined_df |> mutate(Country = Country.x) |> dplyr::select(-c(Country.y, Country.x)) |>
  dplyr::select(Country, everything()) -> combined_df

#combined_df |> select(-c(has_facebook_office, has_google_office, has_twitter_office)) ->
#  combined_df



```



#load in country GDP data, should be similar to world bank data
#"./API_NY.GDP.MKTP.CD_DS2_en_csv_v2_31795.csv"

```{r}
#mango

gdp_df <- read_csv("../data/API_NY.GDP.MKTP.CD_DS2_en_csv_v2_31795.csv", col_names = TRUE, skip=4)
head(gdp_df)


gdp_df <- gdp_df |> 
  dplyr::select(c(`Country Name`, `Country Code`)| starts_with('201') | starts_with('202')) |>
  dplyr::select(!c("2010", "2011", "2012"))
names(gdp_df)

```





```{r}
#pivot longer to group cols 
gdp_df_fixed <- gdp_df |> pivot_longer(cols = starts_with('20'), names_to = "year", values_to = "GDP")
names(gdp_df_fixed)
gdp_df_fixed |> dplyr::select(-`Country Name`) -> gdp_df_fixed


gdp_df_fixed$year <- as.numeric(gdp_df_fixed$year)



#help(pivot_longer)
```




```{r}
#head(combined_df)



combined_df |> left_join(gdp_df_fixed, by = c("country_code" = "Country Code", "year" = "year")) -> joined_combined_df
joined_combined_df |> dplyr::select(c(Country,country_code, population, year) )

joined_combined_df$country_code <- as.factor(joined_combined_df$country_code)

```

```{r}
joined_combined_df$year <- as.numeric(joined_combined_df$year)
joined_combined_df
head(combined_df)
joined_combined_df -> combined_df
```








#add in v2smgovsmmon, v2smgovfilcap, v2smarrest


```{r}
civic_df <- read_csv("../data/DSP_CY_v6.csv", col_names = TRUE)
head(civic_df)


civic_df <- civic_df |> 
  dplyr::select(c("country_name", "country_text_id", "year","v2smgovsmmon", "v2smgovfilcap", "v2smarrest"))
names(civic_df)

```




```{r}
civic_df$year <- as.numeric(civic_df$year)

combined_df |> left_join(civic_df, by = c("country_code" = "country_text_id", "year" = "year")) -> combined_df


head(combined_df)
```
#load in political regime type

```{r}
regime_df <- read_csv("../data/political-regime.csv", col_names = TRUE)

#regime_df

regime_df <- regime_df |>
  dplyr::select(c("Entity","Code","Year", "Political regime"))
names(regime_df)

regime_df <- regime_df |>
  filter(Year >= 2013)

regime_df
regime_df$year <- as.numeric(regime_df$Year)
regime_df
#regime_df <- regime_df |> select(-Year)

head(regime_df)

names(combined_df)
names(regime_df)



#regime_df |> mutate(Code = str_trim(Code)) -> regime_df


#filter(Entity %in% c("Egypt", "Kosovo", "Palestine"))

#combined_df |> filter(Country %in% c("Egypt", "Kosovo", "Palestine"))

combined_df |>
  left_join(regime_df, by = c("country_code" = "Code", "year" = "year")) |> mutate(`Political regime` = case_when(
    Country == "Kosovo" ~ 2,
    Country == "Egypt" ~ 1, 
    TRUE~ `Political regime`
  )) |> dplyr::select(-c(country_name.x, Entity)) -> combined_df



#no_regime_countries

#unique(no_regime_countries$Country)



combined_df
```



#Use later for assessing associations between variables
```{r}
combined_df |> dplyr::select(-c(`Country Name`, country_name.y )) -> combined_df



#install.packages("GGally")

#ggpairs(df, columns=c(..,..,..,..))
#ggpairs(sat, columns = 2:8)
```

#add total content restrictions by country



```{r}
file_list <- list.files(path = "~/joe_sturla_r/2024_takedown_analysis/data/", pattern ="Content_Restrictions_20?", full.names = TRUE) 
data_list <- list()

file_list
```

```{r}
data_list <- list()
for (file in file_list) {
  # Read the current CSV file into a dataframe
  #print(file)
  df <- read.csv(file)
  
  # Extract the file name from the file path
  file_name <- basename(file)
  
  # Extract the year and half information from the file name
  # Assuming the format is like "PRPL-Facebook-Government-Report-YYYY_HX"
  # Where YYYY is the year and HX is the half of the year (H1 or H2)
  year_half <- gsub(".*_(\\d{4})_(H[12]).csv$", "\\1_\\2", file_name)
  
  # Split the extracted information into year and half
  year <- sub("_(H[12])$", "", year_half)
  half <- sub("^\\d{4}_(H[12])$", "\\1", year_half)
  
  # Determine the date based on the half of the year
  if (half == "H1") {
    date <- paste0("6/30/", year)
  } else if (half == "H2") {
    date <- paste0("12/31/", year)
  } else {
    date <- NA  # Handle unexpected cases
  }
  
  # df$Total.Requests.Percentage <- df$Total.Requests.Percentage|> 
  # str_replace_all("%|,", "")
  # 
  # 
  # df$Total.Requests <- sub(" -.*", "", df$Total.Requests)
  # df$Total.Requests <- df$Total.Requests |>
  #   str_replace_all("%|,", "")
  # 
  # df$Total.Requests.Accounts <- sub(" -.*", "", df$Total.Requests.Accounts)
  # df$Total.Requests.Accounts <- df$Total.Requests.Accounts |>
  #   str_replace_all("%|,", "")
  #   #unique(df$Total.Requests.Accounts)
  # 
  
  for (col in names(df)) {
    #print(col)
    if (col != "Country") {
      # Try to convert columns to numeric if they are not character columns
      # This will also handle integer and double columns consistently
      df[[col]] <- sub(" -.*", "", df[[col]])
      df[[col]] <- df[[col]] |>
        str_replace_all("%|,", "")
      
      df[[col]] <- as.numeric(df[[col]])
    }
  }
  
  # Add a new column with the date information
  df$Date <- date
  
  # Append the dataframe to the list
  data_list[[length(data_list) + 1]] <- df
}

```


```{r}

content_restrictions_df <- bind_rows(data_list)
head(content_restrictions_df)
unique(content_restrictions_df$count)
```
#TODO fix NAs from coercion above by combining totals and count columns, then removing subcategory columns, then coalescing by date + add year column.\

#find out are totals for each half of the year combined currently? they should be so that year accurately represents the totals.








#begin models
#start with just libdem and total requests
```{r}
names(combined_df)
#Should contain Country, country_code, year, platform, Date, libdem, social media gov metrics, population, percent pop on internet, regime type, existence of a facebook office, GDP

model_df <- combined_df
#names(model_df)

model_df$country_code <- as.factor(model_df$country_code)
model_df$year <- as.numeric(model_df$year)
  
model <- lm(Total.Requests ~ v2x_libdem + year, data = model_df)
summary(model)

sum(is.na(model_df$Total.Requests.Percentage))

```


#removing NAs/ irrelevant columns
```{r}
sapply(model_df, function(x) sum(is.na(x)))
model_df |> dplyr::select(c(-starts_with('Court'), -starts_with('Legal'), -starts_with('Emergency'), -starts_with('Subpoena'), -starts_with('Pen'), -starts_with('Title'), -starts_with('Search'), -starts_with('ER'), -starts_with('Preservation'))) -> model_df_cut_cols

model_df_cut_cols
model_df_cut_cols |> filter(!is.na(Total.Requests.Percentage)) ->model_df_cut_cols
sapply(model_df_cut_cols, function(x) sum(is.na(x)))



model_df_cut_cols |> filter(is.na(v2x_libdem))

```


#fixes column names, TODO is to remove values that have NAs so that stepwise AIC will run properly
```{r}

#names(model_df)
model_df_cut_cols |> mutate(political_regime = `Political regime`) -> model_df_cut_cols



```

#trains model on all relevant variables included

#NOTE: 
```{r}



#Total requests number
total_requests_all_vars <- lm(Total.Requests ~ v2x_libdem + has_facebook_office +GDP + v2smgovsmmon+v2smgovfilcap+ v2smarrest+ political_regime + year + population + percent_pop_on_internet, data = model_df_cut_cols)
summary(total_requests_all_vars)
```



```{r}


stepwise_model <- stepAIC(total_requests_all_vars, direction = "both")

```




```{r}
#Total requests percentage as a function of libdem, year, population
#total requests percentage IS impacted by libdem score
model_requests_percent <- lm(Total.Requests.Percentage ~ v2x_libdem + year, data = model_df)
summary(model_requests_percent)



model_requests_percent_pop <- lm(Total.Requests.Percentage ~ v2x_libdem + year + population, data = model_df)
summary(model_requests_percent_pop)
```


```{r}
model_offices <- lm(Total.Requests ~ v2x_libdem + has_facebook_office + year + population, data = model_df)
summary(model_offices)

model_offices_percent <- lm(Total.Requests.Percentage ~ has_facebook_office + year, data = model_df)
summary(model_offices_percent)

model_offices_base <- lm(Total.Requests ~ has_facebook_office + year , data = model_df)
summary(model_offices_base)
```

#filter df used to only include countries that have below a .85 vdem score
```{r}
#names(model_df)

model_df <- model_df |> 
  mutate("political_regime" = `Political regime`) |>
  select(-`Political regime`)
model_df$political_regime <- as.factor(model_df$political_regime)

typeof(model_df$political_regime)
type(model_df$political_regime)


no_dem_data <- model_df |>
  filter(v2x_libdem <.85)

```


rerun models on new df
```{r}
model_offices_nodem <- glm(Total.Requests ~ v2x_libdem + has_facebook_office + year + population, data = no_dem_data)
summary(model_offices_nodem)

model_offices_percent_nodem <- glm(Total.Requests ~ has_facebook_office + year, data = no_dem_data)
summary(model_offices_percent_nodem)

model_offices_base_nodem <- glm(Total.Requests ~ has_facebook_office + year , data = no_dem_data)
summary(model_offices_base_nodem)
```
```{r}
model_offices_nodem <- glm(Total.Requests.Percentage ~ v2x_libdem + has_facebook_office + year + population, data = no_dem_data)
summary(model_offices_nodem)

model_offices_percent_nodem <- glm(Total.Requests.Percentage ~ has_facebook_office + year, data = no_dem_data)
summary(model_offices_percent_nodem)

model_offices_base_nodem <- glm(Total.Requests.Percentage ~ has_facebook_office + year , data = no_dem_data)
summary(model_offices_base_nodem)
```

```{r}
v2smgovfilcap_nodem <- glm(Total.Requests.Percentage ~ v2smgovfilcap + has_facebook_office + year + population, data = no_dem_data)
summary(v2smgovfilcap_nodem)


v2smgovsmmon_nodem <- glm(Total.Requests.Percentage ~ v2smgovsmmon + has_facebook_office + year + population, data = no_dem_data)
summary(v2smgovsmmon_nodem)

v2smarrest_nodem <- glm(Total.Requests.Percentage ~ v2smarrest + has_facebook_office + year + population, data = no_dem_data)
summary(v2smarrest_nodem)

all_nodem <- glm(Total.Requests.Percentage ~ v2smarrest + v2smgovsmmon + v2smgovfilcap + has_facebook_office + year + population, data = no_dem_data)
summary(all_nodem)


(max(no_dem_data$v2smgovfilcap))
(min(no_dem_data$v2smgovfilcap))
no_dem_data |> filter(v2smgovfilcap > 2) |> select(Country, v2smgovfilcap)
```



#removing NAs/ irrelevant columns
```{r}
sapply(model_df_cut_cols, function(x) sum(is.na(x)))
model_df |> select(c(-starts_with('Court'), -starts_with('Legal'), -starts_with('Emergency'), -starts_with('Subpoena'), -starts_with('Pen'), -starts_with('Title'), -starts_with('Search'))) -> model_df_cut_cols


model_df_cut_cols |> filter(!is.na(Total.Requests.Percentage)) ->model_df_cut_cols
sapply(model_df_cut_cols, function(x) sum(is.na(x)))



model_df_cut_cols |> filter(is.na(v2x_libdem))

```


```{r}


all_relevant_vars <- lm(Total.Requests.Percentage ~ v2x_libdem + political_regime + v2smarrest + v2smgovsmmon + v2smgovfilcap + has_facebook_office + year + population + percent_pop_on_internet + GDP, data = model_df)
summary(all_regime)
```



